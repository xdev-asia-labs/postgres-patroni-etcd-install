# Prometheus Configuration
# Generated by Ansible - DO NOT EDIT MANUALLY

global:
  scrape_interval: {{ prometheus_scrape_interval }}
  evaluation_interval: {{ prometheus_evaluation_interval }}
  external_labels:
    cluster: '{{ prometheus_cluster_name }}'
    environment: '{{ prometheus_environment }}'

{% if prometheus_alerting_enabled | bool %}
# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
{% for target in prometheus_alertmanager_targets %}
            - '{{ target }}'
{% endfor %}
{% endif %}

# Load rules once and periodically evaluate them
rule_files:
{% if prometheus_alerting_enabled | bool %}
  - "{{ prometheus_config_dir }}/rules/*.yml"
{% endif %}

# Scrape configurations
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:{{ prometheus_web_listen_port }}']

  # Node Exporter - System metrics from all nodes
  - job_name: 'node_exporter'
    static_configs:
      - targets:
{% for host in groups['postgres'] %}
          - '{{ hostvars[host]['ansible_host'] }}:{{ node_exporter_port }}'
{% endfor %}
        labels:
          cluster: 'postgres-ha'

  # PostgreSQL Exporter - Database metrics
  - job_name: 'postgres_exporter'
    static_configs:
      - targets:
{% for host in groups['postgres'] %}
          - '{{ hostvars[host]['ansible_host'] }}:{{ postgres_exporter_port }}'
{% endfor %}
        labels:
          cluster: 'postgres-ha'

  # Patroni - HA cluster metrics
  - job_name: 'patroni'
    static_configs:
      - targets:
{% for host in groups['postgres'] %}
          - '{{ hostvars[host]['ansible_host'] }}:{{ patroni_api_port }}'
{% endfor %}
        labels:
          cluster: 'postgres-ha'
    metrics_path: '/metrics'

  # etcd - DCS metrics
  - job_name: 'etcd'
    static_configs:
      - targets:
{% for host in groups['postgres'] %}
          - '{{ hostvars[host]['ansible_host'] }}:{{ etcd_client_port }}'
{% endfor %}
        labels:
          cluster: 'etcd-patroni'
    metrics_path: '/metrics'

  # PgBouncer Exporter - Connection pooling metrics
  - job_name: 'pgbouncer_exporter'
    static_configs:
      - targets:
{% for host in groups['postgres'] %}
          - '{{ hostvars[host]['ansible_host'] }}:{{ pgbouncer_exporter_port }}'
{% endfor %}
        labels:
          cluster: 'postgres-ha'
