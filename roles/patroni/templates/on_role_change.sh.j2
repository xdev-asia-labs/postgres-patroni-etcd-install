#!/bin/bash
# Patroni callback script: on_role_change
# Generated by Ansible - Do not edit manually
#
# This script is called when the PostgreSQL role changes (primary <-> replica)
#
# Arguments:
#   $1 - action (on_start, on_stop, on_role_change)
#   $2 - role (master, replica)
#   $3 - cluster name

ACTION=$1
ROLE=$2
CLUSTER=$3
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
LOGFILE="{{ postgresql_data_dir }}/log/patroni_callbacks.log"
HOSTNAME=$(hostname)

# Log function
log() {
    echo "[$TIMESTAMP] [$HOSTNAME] [$ACTION] [$ROLE] $1" >> $LOGFILE
}

log "Role change detected: $ROLE"

# Actions based on new role
case $ROLE in
    master|primary)
        log "Node promoted to PRIMARY"
        
        # Add your custom actions here, for example:
        # - Send notification to monitoring system
        # - Update load balancer configuration
        # - Execute custom scripts
        
        # Example: Send alert (uncomment and configure)
        # curl -X POST -H 'Content-type: application/json' \
        #     --data "{\"text\":\"PostgreSQL Cluster: $CLUSTER - Node $HOSTNAME promoted to PRIMARY\"}" \
        #     https://hooks.slack.com/services/YOUR/WEBHOOK/URL
        
        ;;
    replica|standby)
        log "Node demoted to REPLICA"
        
        # Add your custom actions here, for example:
        # - Send notification to monitoring system
        # - Update load balancer configuration
        
        ;;
    *)
        log "Unknown role: $ROLE"
        ;;
esac

exit 0
