# Patroni Configuration File
# Generated by Ansible - Do not edit manually
# 
# Documentation: https://patroni.readthedocs.io/

# =============================================================================
# CLUSTER IDENTIFICATION
# =============================================================================
scope: {{ patroni_scope }}
namespace: {{ patroni_namespace }}
name: {{ patroni_name }}

# =============================================================================
# REST API
# =============================================================================
restapi:
  listen: 0.0.0.0:{{ patroni_api_port }}
  connect_address: {{ ansible_host }}:{{ patroni_api_port }}
{% if patroni_restapi_auth_enabled | default(false) %}
  authentication:
    username: {{ patroni_restapi_username }}
    password: {{ patroni_restapi_password }}
{% endif %}

# =============================================================================
# ETCD (Distributed Configuration Store)
# =============================================================================
etcd3:
  hosts: {% for host in groups['postgres'] %}{{ hostvars[host]['ansible_host'] }}:{{ etcd_client_port }}{% if not loop.last %},{% endif %}{% endfor %}

{% if etcd_auth_enabled | default(false) %}
  username: root
  password: {{ etcd_root_password }}
{% endif %}

# =============================================================================
# BOOTSTRAP CONFIGURATION
# =============================================================================
bootstrap:
  dcs:
    # Leader lock TTL (seconds)
    ttl: {{ patroni_ttl }}
    
    # Health check interval (seconds)
    loop_wait: {{ patroni_loop_wait }}
    
    # DCS operation timeout (seconds)
    retry_timeout: {{ patroni_retry_timeout }}
    
    # Maximum replication lag for failover eligibility (bytes)
    maximum_lag_on_failover: {{ patroni_maximum_lag_on_failover }}
    
{% if patroni_synchronous_mode | default(false) %}
    # Synchronous replication settings
    synchronous_mode: true
    synchronous_mode_strict: {{ patroni_synchronous_mode_strict | default(false) | lower }}
    synchronous_node_count: {{ patroni_synchronous_node_count | default(1) }}
{% endif %}
    
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        # Replication settings
        wal_level: {{ postgresql_wal_level }}
        hot_standby: "{{ postgresql_hot_standby }}"
        max_wal_senders: {{ postgresql_max_wal_senders }}
        max_replication_slots: {{ postgresql_max_replication_slots }}
        wal_keep_size: "{{ postgresql_wal_keep_size }}"
        wal_log_hints: "{{ postgresql_wal_log_hints }}"
        
        # Performance settings
        max_connections: {{ postgresql_max_connections }}
        shared_buffers: "{{ postgresql_shared_buffers }}"
        effective_cache_size: "{{ postgresql_effective_cache_size }}"
        maintenance_work_mem: "{{ postgresql_maintenance_work_mem }}"
        checkpoint_completion_target: {{ postgresql_checkpoint_completion_target }}
        wal_buffers: "{{ postgresql_wal_buffers }}"
        work_mem: "{{ postgresql_work_mem }}"
        min_wal_size: "{{ postgresql_min_wal_size }}"
        max_wal_size: "{{ postgresql_max_wal_size }}"
        
        # Logging
{% if logging_enabled | default(true) %}
        log_destination: "{{ log_destination | default('stderr') }}"
        logging_collector: "{{ logging_collector | default('on') }}"
        log_directory: "{{ log_directory | default('log') }}"
        log_filename: "{{ log_filename | default('postgresql-%Y-%m-%d_%H%M%S.log') }}"
        log_rotation_age: "{{ log_rotation_age | default('1d') }}"
        log_rotation_size: "{{ log_rotation_size | default('100MB') }}"
        log_min_messages: "{{ log_min_messages | default('warning') }}"
        log_min_error_statement: "{{ log_min_error_statement | default('error') }}"
        log_line_prefix: "{{ log_line_prefix | default('%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h ') }}"
{% endif %}

{% if postgresql_ssl_enabled | default(false) %}
        # SSL settings
        ssl: "on"
        ssl_cert_file: "{{ postgresql_ssl_cert_file }}"
        ssl_key_file: "{{ postgresql_ssl_key_file }}"
{% endif %}

  # Initialize database with these options
  initdb:
    - encoding: UTF8
    - data-checksums
    - locale: en_US.UTF-8

  # pg_hba.conf entries
  pg_hba:
    # Replication connections
{% for host in groups['postgres'] %}
    - host replication {{ postgresql_replication_user }} {{ hostvars[host]['ansible_host'] }}/32 scram-sha-256
{% endfor %}
    # Local connections
    - local all all peer
    - host all all 127.0.0.1/32 scram-sha-256
    - host all all ::1/128 scram-sha-256
    # Cluster network only (secure)
    - host all all {{ cluster_network }} scram-sha-256

  # Users to create during bootstrap
  users:
    {{ postgresql_admin_user }}:
      password: {{ postgresql_admin_password }}
      options:
        - createrole
        - createdb

# =============================================================================
# POSTGRESQL CONFIGURATION
# =============================================================================
postgresql:
  listen: 0.0.0.0:{{ postgresql_port }}
  connect_address: {{ ansible_host }}:{{ postgresql_port }}
  data_dir: {{ postgresql_data_dir }}
{% if ansible_os_family == "Debian" %}
  bin_dir: /usr/lib/postgresql/{{ postgresql_version }}/bin
{% else %}
  bin_dir: /usr/pgsql-{{ postgresql_version }}/bin
{% endif %}
  pgpass: /tmp/pgpass
  
  authentication:
    replication:
      username: {{ postgresql_replication_user }}
      password: {{ postgresql_replication_password }}
    superuser:
      username: {{ postgresql_superuser }}
      password: {{ postgresql_superuser_password }}
    rewind:
      username: {{ postgresql_superuser }}
      password: {{ postgresql_superuser_password }}

  # Additional runtime parameters (optional)
  parameters:
    unix_socket_directories: '/var/run/postgresql'

{% if patroni_callbacks_enabled | default(true) %}
  # Callback scripts
  callbacks:
    on_start: {{ patroni_scripts_dir }}/on_start.sh
    on_stop: {{ patroni_scripts_dir }}/on_stop.sh
    on_role_change: {{ patroni_scripts_dir }}/on_role_change.sh
{% endif %}

# =============================================================================
# TAGS
# =============================================================================
tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false

{% if patroni_watchdog_mode != 'off' %}
# =============================================================================
# WATCHDOG
# =============================================================================
watchdog:
  mode: {{ patroni_watchdog_mode }}
  device: /dev/watchdog
  safety_margin: 5
{% endif %}
