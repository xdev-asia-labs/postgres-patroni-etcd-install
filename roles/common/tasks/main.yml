---
# Common Role - Cài đặt các gói cơ bản và cấu hình hệ thống

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Update dnf cache
  dnf:
    update_cache: yes
  when: ansible_os_family == "RedHat"

# =============================================================================
# INSTALL COMMON PACKAGES
# =============================================================================
- name: Install common packages (Debian/Ubuntu)
  apt:
    name:
      - wget
      - curl
      - vim
      - htop
      - iotop
      - net-tools
      - dnsutils
      - gnupg2
      - software-properties-common
      - apt-transport-https
      - ca-certificates
      - python3
      - python3-pip
      - python3-dev
      - python3-venv
      - jq
      - netcat-openbsd
    state: present
  when: ansible_os_family == "Debian"

- name: Install common packages (RedHat)
  dnf:
    name:
      - wget
      - curl
      - vim
      - htop
      - iotop
      - net-tools
      - bind-utils
      - gnupg2
      - python3
      - python3-pip
      - python3-devel
      - jq
      - nc
    state: present
  when: ansible_os_family == "RedHat"

# =============================================================================
# HOSTNAME CONFIGURATION
# =============================================================================
- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"

- name: Update /etc/hosts
  template:
    src: hosts.j2
    dest: /etc/hosts
    owner: root
    group: root
    mode: "0644"

# =============================================================================
# TIME SYNCHRONIZATION
# =============================================================================
- name: Install chrony (Debian/Ubuntu)
  apt:
    name: chrony
    state: present
  when:
    - ansible_os_family == "Debian"
    - ntp_enabled | default(true)

- name: Install chrony (RedHat)
  dnf:
    name: chrony
    state: present
  when:
    - ansible_os_family == "RedHat"
    - ntp_enabled | default(true)

- name: Configure chrony
  template:
    src: chrony.conf.j2
    dest: /etc/chrony/chrony.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart chrony
  when: ntp_enabled | default(true)

- name: Set timezone
  timezone:
    name: "{{ ntp_timezone | default('Asia/Ho_Chi_Minh') }}"

- name: Enable and start chrony
  systemd:
    name: chronyd
    enabled: yes
    state: started
  when: ntp_enabled | default(true)

# =============================================================================
# FIREWALL CONFIGURATION - UFW
# =============================================================================
- name: Install UFW
  apt:
    name: ufw
    state: present
  when:
    - ansible_os_family == "Debian"
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'ufw'

- name: Configure UFW - Allow SSH
  ufw:
    rule: allow
    port: "22"
    proto: tcp
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'ufw'

- name: Configure UFW - Allow PostgreSQL
  ufw:
    rule: allow
    src: "{{ cluster_network }}"
    port: "{{ postgresql_port | default(5432) }}"
    proto: tcp
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'ufw'
    - "'postgres' in group_names"

- name: Configure UFW - Allow Patroni REST API
  ufw:
    rule: allow
    src: "{{ cluster_network }}"
    port: "{{ patroni_api_port | default(8008) }}"
    proto: tcp
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'ufw'
    - "'postgres' in group_names"

- name: Configure UFW - Allow etcd client port
  ufw:
    rule: allow
    src: "{{ cluster_network }}"
    port: "{{ etcd_client_port | default(2379) }}"
    proto: tcp
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'ufw'
    - "'postgres' in group_names"

- name: Configure UFW - Allow etcd peer port
  ufw:
    rule: allow
    src: "{{ cluster_network }}"
    port: "{{ etcd_peer_port | default(2380) }}"
    proto: tcp
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'ufw'
    - "'postgres' in group_names"

- name: Enable UFW
  ufw:
    state: enabled
    policy: deny
    direction: incoming
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'ufw'

# =============================================================================
# FIREWALL CONFIGURATION - FIREWALLD
# =============================================================================
- name: Install firewalld
  dnf:
    name: firewalld
    state: present
  when:
    - ansible_os_family == "RedHat"
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'firewalld'

- name: Start and enable firewalld
  systemd:
    name: firewalld
    enabled: yes
    state: started
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'firewalld'

- name: Configure firewalld - Allow PostgreSQL
  firewalld:
    port: "{{ postgresql_port | default(5432) }}/tcp"
    permanent: yes
    state: enabled
    immediate: yes
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'firewalld'
    - "'postgres' in group_names"

- name: Configure firewalld - Allow Patroni
  firewalld:
    port: "{{ patroni_api_port | default(8008) }}/tcp"
    permanent: yes
    state: enabled
    immediate: yes
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'firewalld'
    - "'postgres' in group_names"

- name: Configure firewalld - Allow etcd client
  firewalld:
    port: "{{ etcd_client_port | default(2379) }}/tcp"
    permanent: yes
    state: enabled
    immediate: yes
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'firewalld'
    - "'postgres' in group_names"

- name: Configure firewalld - Allow etcd peer
  firewalld:
    port: "{{ etcd_peer_port | default(2380) }}/tcp"
    permanent: yes
    state: enabled
    immediate: yes
  when:
    - firewall_enabled | default(true)
    - firewall_type | default('ufw') == 'firewalld'
    - "'postgres' in group_names"

# =============================================================================
# SYSTEM TUNING
# =============================================================================
- name: Configure sysctl for PostgreSQL
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    state: present
    reload: yes
  loop:
    - { name: "vm.swappiness", value: "10" }
    - { name: "vm.overcommit_memory", value: "2" }
    - { name: "vm.overcommit_ratio", value: "80" }
    - { name: "kernel.shmmax", value: "17179869184" }
    - { name: "kernel.shmall", value: "4194304" }
    - { name: "net.core.somaxconn", value: "65535" }
    - { name: "net.ipv4.tcp_max_syn_backlog", value: "65535" }
    - { name: "net.ipv4.ip_local_port_range", value: "1024 65535" }
  when: "'postgres' in group_names"

- name: Configure limits.conf for postgres user
  lineinfile:
    path: /etc/security/limits.conf
    line: "{{ item }}"
    create: yes
  loop:
    - "postgres soft nofile 65536"
    - "postgres hard nofile 65536"
    - "postgres soft nproc 65536"
    - "postgres hard nproc 65536"
  when: "'postgres' in group_names"

# =============================================================================
# DISABLE SELINUX (RedHat)
# =============================================================================
- name: Disable SELinux
  selinux:
    state: disabled
  when: ansible_os_family == "RedHat"
  ignore_errors: yes
