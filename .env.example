# PostgreSQL HA Cluster - Complete Configuration Template
# Copy this file to .env and update with your values
# This file should NEVER be committed to git
#
# Usage: Load before running Ansible
#   set -a && source .env && set +a
#   ansible-playbook playbooks/site.yml -i inventory/hosts.yml

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================
CLUSTER_NETWORK=172.23.202.0/24
CLUSTER_NETMASK=255.255.255.0

# Node IP Addresses
NODE1_IP=172.23.202.11
NODE2_IP=172.23.202.12
NODE3_IP=172.23.202.13

# Node Names
NODE1_NAME=pg-node1
NODE2_NAME=pg-node2
NODE3_NAME=pg-node3

# =============================================================================
# POSTGRESQL CONFIGURATION
# =============================================================================
POSTGRESQL_VERSION=18
POSTGRESQL_PORT=5432
POSTGRESQL_DATA_DIR=/var/lib/postgresql/18/data
POSTGRESQL_BIN_DIR=/usr/lib/postgresql/18/bin
POSTGRESQL_CONFIG_DIR=/etc/postgresql/18

# PostgreSQL Users
POSTGRESQL_SUPERUSER=postgres
POSTGRESQL_REPLICATION_USER=replicator
POSTGRESQL_ADMIN_USER=admin

# PostgreSQL Passwords (CHANGE THESE!)
POSTGRESQL_SUPERUSER_PASSWORD=change_me_strong_password_123
POSTGRESQL_REPLICATION_PASSWORD=change_me_strong_password_456
POSTGRESQL_ADMIN_PASSWORD=change_me_strong_password_789

# PostgreSQL Performance Tuning (adjust for your hardware)
POSTGRESQL_MAX_CONNECTIONS=100
POSTGRESQL_SHARED_BUFFERS=4GB
POSTGRESQL_EFFECTIVE_CACHE_SIZE=12GB
POSTGRESQL_WORK_MEM=40MB
POSTGRESQL_MAINTENANCE_WORK_MEM=1GB
POSTGRESQL_WAL_BUFFERS=64MB
POSTGRESQL_CHECKPOINT_COMPLETION_TARGET=0.9
POSTGRESQL_MIN_WAL_SIZE=1GB
POSTGRESQL_MAX_WAL_SIZE=4GB
POSTGRESQL_RANDOM_PAGE_COST=1.1
POSTGRESQL_EFFECTIVE_IO_CONCURRENCY=200
POSTGRESQL_MAX_WORKER_PROCESSES=5
POSTGRESQL_MAX_PARALLEL_WORKERS=5
POSTGRESQL_MAX_PARALLEL_WORKERS_PER_GATHER=2
POSTGRESQL_MAX_PARALLEL_MAINTENANCE_WORKERS=2

# PostgreSQL Replication Settings
POSTGRESQL_WAL_LEVEL=replica
POSTGRESQL_HOT_STANDBY=on
POSTGRESQL_MAX_WAL_SENDERS=10
POSTGRESQL_MAX_REPLICATION_SLOTS=10
POSTGRESQL_WAL_KEEP_SIZE=1GB
POSTGRESQL_WAL_LOG_HINTS=on

# PostgreSQL SSL (set to true to enable)
POSTGRESQL_SSL_ENABLED=false
POSTGRESQL_SSL_CERT_FILE=/etc/postgresql/ssl/server.crt
POSTGRESQL_SSL_KEY_FILE=/etc/postgresql/ssl/server.key

# =============================================================================
# ETCD CONFIGURATION
# =============================================================================
ETCD_VERSION=3.5.25
ETCD_CLIENT_PORT=2379
ETCD_PEER_PORT=2380
ETCD_DATA_DIR=/var/lib/etcd
ETCD_CONFIG_DIR=/etc/etcd
ETCD_CLUSTER_TOKEN=etcd-cluster-patroni
ETCD_USER=etcd
ETCD_GROUP=etcd

# etcd Authentication (disabled by default)
ETCD_AUTH_ENABLED=false
ETCD_ROOT_PASSWORD=

# =============================================================================
# PATRONI CONFIGURATION
# =============================================================================
PATRONI_VERSION=4.1.0
PATRONI_CONFIG_DIR=/etc/patroni
PATRONI_SCOPE=postgres
PATRONI_NAMESPACE=/service/
PATRONI_API_PORT=8008

# Patroni DCS Settings
PATRONI_TTL=30
PATRONI_LOOP_WAIT=10
PATRONI_RETRY_TIMEOUT=10
PATRONI_MAXIMUM_LAG_ON_FAILOVER=1048576

# Patroni Synchronous Mode (false for async replication)
PATRONI_SYNCHRONOUS_MODE=false
PATRONI_SYNCHRONOUS_MODE_STRICT=false
PATRONI_SYNCHRONOUS_NODE_COUNT=1

# Patroni REST API Authentication
PATRONI_RESTAPI_AUTH_ENABLED=false
PATRONI_RESTAPI_USERNAME=admin
PATRONI_RESTAPI_PASSWORD=change_me_admin_password

# Patroni Callbacks
PATRONI_CALLBACKS_ENABLED=true
PATRONI_SCRIPTS_DIR=/etc/patroni/scripts

# Patroni Watchdog
PATRONI_WATCHDOG_MODE=off

# =============================================================================
# PGBOUNCER CONFIGURATION
# =============================================================================
PGBOUNCER_ENABLED=true
PGBOUNCER_LISTEN_PORT=6432
PGBOUNCER_LISTEN_ADDR=*
PGBOUNCER_AUTH_TYPE=md5
PGBOUNCER_POOL_MODE=transaction

# PgBouncer Connection Limits
PGBOUNCER_MAX_CLIENT_CONN=1000
PGBOUNCER_DEFAULT_POOL_SIZE=25
PGBOUNCER_MIN_POOL_SIZE=5
PGBOUNCER_RESERVE_POOL_SIZE=5
PGBOUNCER_RESERVE_POOL_TIMEOUT=3
PGBOUNCER_MAX_DB_CONNECTIONS=50
PGBOUNCER_MAX_USER_CONNECTIONS=50

# PgBouncer Timeouts
PGBOUNCER_SERVER_IDLE_TIMEOUT=600
PGBOUNCER_CLIENT_IDLE_TIMEOUT=0
PGBOUNCER_SERVER_CONNECT_TIMEOUT=15
PGBOUNCER_SERVER_LOGIN_RETRY=15
PGBOUNCER_QUERY_TIMEOUT=0
PGBOUNCER_QUERY_WAIT_TIMEOUT=120

# PgBouncer Logging
PGBOUNCER_LOG_CONNECTIONS=0
PGBOUNCER_LOG_DISCONNECTIONS=0
PGBOUNCER_STATS_PERIOD=60

# =============================================================================
# HAPROXY CONFIGURATION (DISABLED)
# =============================================================================
HAPROXY_ENABLED=false

# =============================================================================
# FIREWALL CONFIGURATION
# =============================================================================
FIREWALL_ENABLED=true
FIREWALL_TYPE=ufw

# =============================================================================
# TIME SYNCHRONIZATION
# =============================================================================
NTP_ENABLED=true
NTP_TIMEZONE=Asia/Ho_Chi_Minh
NTP_SERVERS=0.asia.pool.ntp.org,1.asia.pool.ntp.org,2.asia.pool.ntp.org

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
LOGGING_ENABLED=true
LOG_DESTINATION=stderr
LOGGING_COLLECTOR=on
LOG_DIRECTORY=log
LOG_FILENAME=postgresql-%Y-%m-%d_%H%M%S.log
LOG_ROTATION_AGE=1d
LOG_ROTATION_SIZE=100MB
LOG_MIN_MESSAGES=warning
LOG_MIN_ERROR_STATEMENT=error
LOG_LINE_PREFIX='%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h ' 

# =============================================================================
# APPLICATION DATABASES CONFIGURATION
# =============================================================================
# Enable/disable automatic database creation
APP_DATABASES_ENABLED=true

# List of databases to create (JSON format)
# Format: [{"name": "db_name", "user": "db_user", "password": "secure_password"}]
# Run: ansible-playbook playbooks/create-database.yml -i inventory/hosts.yml
APP_DATABASES='[
  {"name": "myapp_db", "user": "myapp_user", "password": "ChangeMe@SecurePass#2024"},
  {"name": "another_db", "user": "another_user", "password": "AnotherSecure@Pass#2024"}
]'

# Database encoding defaults
APP_DB_ENCODING=UTF8
APP_DB_LC_COLLATE=en_US.UTF-8
APP_DB_LC_CTYPE=en_US.UTF-8

# =============================================================================
# GENERATED CONNECTION STRINGS
# =============================================================================
# Use these connection strings after replacing variables:
#
# PgBouncer (RECOMMENDED for applications):
#   postgresql://postgres:${POSTGRESQL_SUPERUSER_PASSWORD}@${NODE1_IP}:${PGBOUNCER_LISTEN_PORT}/postgres
#   jdbc:postgresql://${NODE1_IP}:${PGBOUNCER_LISTEN_PORT},${NODE2_IP}:${PGBOUNCER_LISTEN_PORT},${NODE3_IP}:${PGBOUNCER_LISTEN_PORT}/postgres
#
# Direct PostgreSQL (for admin/maintenance):
#   postgresql://postgres:${POSTGRESQL_SUPERUSER_PASSWORD}@${NODE1_IP}:${POSTGRESQL_PORT}/postgres
#   jdbc:postgresql://${NODE1_IP}:${POSTGRESQL_PORT},${NODE2_IP}:${POSTGRESQL_PORT},${NODE3_IP}:${POSTGRESQL_PORT}/postgres?targetServerType=primary
#
# Patroni Health Checks:
#   http://${NODE1_IP}:${PATRONI_API_PORT}/health
#   http://${NODE2_IP}:${PATRONI_API_PORT}/health
#   http://${NODE3_IP}:${PATRONI_API_PORT}/health

# =============================================================================
# MONITORING CONFIGURATION (Prometheus + Grafana)
# =============================================================================

# Monitoring Enable/Disable
# Set to 'true' to enable monitoring stack deployment
# Set to 'false' to skip monitoring during deployment
MONITORING_ENABLED=true

# Monitoring Server Configuration
# Can be a separate dedicated monitoring server or one of the postgres nodes
# If using separate server, add it to inventory/hosts.yml monitoring group
# Default: pg-node1 (172.23.202.11)
MONITORING_SERVER_IP=172.23.202.11
MONITORING_SERVER_NAME=pg-node1

# Prometheus Configuration
PROMETHEUS_VERSION=3.0.1
PROMETHEUS_PORT=9090
PROMETHEUS_BIN_DIR=/usr/local/bin
PROMETHEUS_CONFIG_DIR=/etc/prometheus
PROMETHEUS_DATA_DIR=/var/lib/prometheus
PROMETHEUS_RETENTION_TIME=30d
PROMETHEUS_RETENTION_SIZE=50GB
PROMETHEUS_SCRAPE_INTERVAL=15s
PROMETHEUS_EVALUATION_INTERVAL=15s
PROMETHEUS_CLUSTER_NAME=postgres-ha
PROMETHEUS_ENVIRONMENT=production

# Prometheus Alerting
PROMETHEUS_ALERTING_ENABLED=true
PROMETHEUS_ALERTMANAGER_TARGETS=localhost:9093
PROMETHEUS_EXTERNAL_URL=

# Grafana Configuration
GRAFANA_VERSION=latest
GRAFANA_PORT=3000
GRAFANA_DOMAIN=localhost
GRAFANA_ROOT_URL=http://localhost:3000
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=ChangeMe@AdminPass#2024
GRAFANA_SECRET_KEY=SW2YcwTIb9zpOOhoPsMm
GRAFANA_DISABLE_GRAVATAR=false
GRAFANA_ALLOW_SIGN_UP=false

# Prometheus Datasource for Grafana
PROMETHEUS_URL=http://localhost:9090
PROMETHEUS_ACCESS=proxy

# Node Exporter (System Metrics)
NODE_EXPORTER_VERSION=1.8.2
NODE_EXPORTER_PORT=9100
NODE_EXPORTER_BIN_DIR=/usr/local/bin

# PostgreSQL Exporter (Database Metrics)
POSTGRES_EXPORTER_VERSION=0.15.0
POSTGRES_EXPORTER_PORT=9187
POSTGRES_EXPORTER_BIN_DIR=/usr/local/bin

# PgBouncer Exporter (Connection Pool Metrics)
PGBOUNCER_EXPORTER_VERSION=0.9.0
PGBOUNCER_EXPORTER_PORT=9127
PGBOUNCER_EXPORTER_BIN_DIR=/usr/local/bin

# =============================================================================
# MONITORING URLS (After deployment)
# =============================================================================
# Prometheus: http://${NODE1_IP}:${PROMETHEUS_PORT}
# Grafana: http://${NODE1_IP}:${GRAFANA_PORT}
# Node Exporter: http://${NODE1_IP}:${NODE_EXPORTER_PORT}/metrics
# PostgreSQL Exporter: http://${NODE1_IP}:${POSTGRES_EXPORTER_PORT}/metrics
# PgBouncer Exporter: http://${NODE1_IP}:${PGBOUNCER_EXPORTER_PORT}/metrics

